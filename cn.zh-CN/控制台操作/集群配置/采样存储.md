# 采样存储

在采样存储页面可以查看上报和存储的Span数据，并设置数据分析的采样比例。

调用链路中90%以上的数据是重复的，价值并不大。您可以通过配置采样规则，只存储符合规格的数据，达到节约成本的目的。

例如：上报100万条Span数据，通过配置采样规则后，只存储符合规则的1万条Span数据，存储成本和查询效率都会得到提升。

**说明：** 当一个Span符合异常或者耗时规则时候，为保证链路的完整性，将会保存这个Span对应的完整链路。

## 功能入口

1.  登录[链路追踪Tracing Analysis控制台](https://tracing.console.aliyun.com/)。

2.  在左侧导航栏中单击**集群配置**。

3.  在右侧页面单击**采样存储**页签。

    ![xTrace集群配置-采样存储](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0331609161/p264779.png)


## 数据说明

-   上报Span总数：当前账号下收到的所有上报Span总数。
-   存储Span总数：基于设置的自定义采样应用，按照一定采样规则过滤后存储的Span总数。
-   全量实时分析（最近半小时）：最近半小时内，上报的用于全量实时分析的Span总数。

上报的数据先运行默认采样规则，再运行自定义采样。

例如：上报100万条Span数据，其中符合异常和耗时规则的为1万条。自定义规则中的Span数为2万，默认采样比例为10%，采样存储逻辑如下：

1.  运行默认采样。优先存储符合异常和耗时规则的为1万条Span数据。再存储10%的条Span数据，即10万条。
2.  运行自定义采样。检查符合自定义采样规则的Span数据，符合采样规则的Span数据为2万条。
3.  可得出一个共存储13万条Span数据。

## 设置默认采样规则

1.  在采样存储页签的默认采样区域，单击**编辑**。

2.  设置以下参数后，单击**保存**。

    -   采样比例：设置调用链的采样率，输入百分比的数字部分即可，例如输入10代表采样10%。
    -   异常全采：存在`error`标签的调用链自动存储。
    -   Span耗时：设置采样的Span耗时的最低阈值，即大于该数值的Span会被存储。
    设置完成后，您可以在默认采样区域右侧查看该采样规则下存储的Span数量。


## 新增自定义采样

1.  在采样存储页签的自定义采样区域，单击**新增自定义采样**。

2.  在添加自定义采样面板中设置采样名称。

3.  在过滤条件区域设置应用名，根据需要设置span名称、tag键和tag值。

    单击**查询**，可以预览当前过滤条件下的所有调用链。

    |参数|说明|
    |--|--|
    |应用名|采样的应用的名称。|
    |span名称|采样的Span名称。|
    |tag键|应用的标签键。|
    |tag值|应用的标签值。|

4.  设置采样比例，然后单击**确定**。

    设置完成后，您可以在自定义采样区域对采样应用进行开启或关闭、编辑、删除等操作，并可以在右上角查看该采样规则下存储的Span数量。


